<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–§–æ—Ä—É–º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#0f111a;color:#eee}
header{background:#151826;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
.container{max-width:900px;margin:20px auto;background:#151826;padding:15px;border-radius:10px}
button{background:#ff6a00;border:none;color:#fff;padding:8px 12px;border-radius:5px;cursor:pointer}
input,textarea{width:100%;background:#1f2236;border:none;color:#fff;padding:10px;border-radius:5px;margin-bottom:10px}
.topic{background:#1f2236;padding:10px;margin-bottom:8px;border-radius:5px;cursor:pointer}
.comment{background:#101320;padding:8px;border-radius:5px;margin:5px 0}
.small{font-size:12px;color:#aaa}
.online{color:#0f0}
.offline{color:#f00}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>

<header>
  <b>–§–æ—Ä—É–º</b>
  <div id="userBar"></div>
</header>

<div class="container" id="forum">
  <button onclick="openEditor()">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ–º—É</button>
  <div id="topics"></div>
</div>

<!-- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è -->
<div id="registerBox" style="display:none" class="container">
  <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
  <input id="nickInput" placeholder="–Ü–º'—è –ü—Ä–∏–∑–≤–∏—â–µ">
  <button onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
</div>

<script>
/* ===== FIREBASE CONFIG (–í–°–¢–ê–í –°–í–û–Ñ) ===== */
firebase.initializeApp({
  apiKey: "–í–ê–®_API_KEY",
  authDomain: "–í–ê–®_DOMAIN",
  databaseURL: "–í–ê–®_DATABASE_URL",
  projectId: "–í–ê–®_PROJECT_ID"
});
const db = firebase.database();

/* ===== USER ===== */
let user = localStorage.getItem("forum_user");
const userBar = document.getElementById("userBar");

if(!user){
  userBar.innerHTML = `<button onclick="showRegister()">üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>`;
}else{
  userBar.innerHTML = `<b>${user}</b> <span id="status"></span> <button onclick="logout()">–í–∏–π—Ç–∏</button>`;
  setOnline(true);
}

/* ===== REGISTRATION ===== */
function showRegister(){
  registerBox.style.display="block";
}

function register(){
  const nick = nickInput.value.trim();
  const regex = /^[–ê-–Ø–Ü–á–Ñ“êA-Z][–∞-—è—ñ—ó—î“ëa-z']+\s[–ê-–Ø–Ü–á–Ñ“êA-Z][–∞-—è—ñ—ó—î“ëa-z']+$/;

  if(!regex.test(nick)){
    alert("–§–æ—Ä–º–∞—Ç: –Ü–º'—è –ü—Ä–∏–∑–≤–∏—â–µ");
    return;
  }

  localStorage.setItem("forum_user", nick);

  db.ref("users").push({
    nick: nick,
    role: "–ì—Ä–∞–≤–µ—Ü—å",
    online: true
  });

  location.reload();
}

/* ===== ONLINE ===== */
function setOnline(state){
  db.ref("presence/"+user).set(state);
  document.getElementById("status").innerHTML =
    state ? `<span class="online">online</span>` : `<span class="offline">offline</span>`;

  window.addEventListener("beforeunload",()=>{
    db.ref("presence/"+user).set(false);
  });
}

/* ===== LOGOUT ===== */
function logout(){
  db.ref("presence/"+user).set(false);
  localStorage.removeItem("forum_user");
  location.reload();
}

/* ===== TOPICS REALTIME ===== */
db.ref("topics").on("value",snap=>{
  const box=document.getElementById("topics");
  box.innerHTML="";
  snap.forEach(s=>{
    const t=s.val();
    const d=document.createElement("div");
    d.className="topic";
    d.innerHTML=`
      <b>${t.title}</b>
      <div class="small">–≤—ñ–¥ ${t.author}</div>
      <div id="c_${s.key}"></div>
      <textarea id="ci_${s.key}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä"></textarea>
      <button onclick="comment('${s.key}')">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    `;
    box.prepend(d);

    db.ref("comments/"+s.key).on("value",cs=>{
      const cbox=document.getElementById("c_"+s.key);
      cbox.innerHTML="";
      cs.forEach(c=>{
        const cd=document.createElement("div");
        cd.className="comment";
        cd.innerHTML=`<b>${c.val().author}:</b> ${c.val().text}`;
        cbox.appendChild(cd);
      });
    });
  });
});

/* ===== CREATE TOPIC ===== */
function openEditor(){
  if(!user){ showRegister(); return; }
  const title=prompt("–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ–º–∏");
  const text=prompt("–¢–µ–∫—Å—Ç");
  if(!title||!text) return;

  db.ref("topics").push({
    title:title,
    text:text,
    author:user,
    time:Date.now()
  });
}

/* ===== COMMENT ===== */
function comment(id){
  const input=document.getElementById("ci_"+id);
  if(!input.value) return;

  db.ref("comments/"+id).push({
    author:user,
    text:input.value,
    time:Date.now()
  });
  input.value="";
}
</script>

</body>
</html>
