<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const auth = firebase.auth();
const db = firebase.database();
let currentUser = null;

/* ===== REGEX NICK ===== */
const nickRegex = /^[А-ЯІЇЄҐ][а-яіїєґ']+\s[А-ЯІЇЄҐ][а-яіїєґ']+$/;

/* ===== REGISTER ===== */
function registerUser(){
  const email = document.getElementById('regEmail').value.trim();
  const pass  = document.getElementById('regPassword').value;
  const nick  = document.getElementById('regUsername').value.trim();

  if(!email || !pass || !nick) return alert("Заповніть всі поля");
  if(!nickRegex.test(nick)) return alert("Нік має бути: Ім'я Прізвище");

  auth.createUserWithEmailAndPassword(email, pass)
    .then(cred=>{
      return db.ref("users/"+cred.user.uid).set({
        nick:nick,
        email:email,
        role:"Гравець",
        avatar:"https://via.placeholder.com/40",
        online:true
      });
    })
    .then(()=>{
      closeRegister();
    })
    .catch(e=>alert(e.message));
}

/* ===== LOGIN ===== */
function loginUser(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPassword').value;

  auth.signInWithEmailAndPassword(email, pass)
    .catch(e=>alert(e.message));
}

/* ===== AUTH STATE ===== */
auth.onAuthStateChanged(user=>{
  if(!user){
    document.getElementById("forum").style.display="none";
    return;
  }

  currentUser = user.uid;

  const userRef = db.ref("users/"+user.uid);
  userRef.update({online:true});

  userRef.on("value",snap=>{
    const u = snap.val();
    if(!u) return;

    document.getElementById("username").textContent = u.nick;
    document.getElementById("userRole").textContent = u.role;
    document.getElementById("avatar").src = u.avatar;
    document.getElementById("forum").style.display="block";

    if(u.role==="Адміністратор"){
      document.getElementById("rolesBtn").style.display="inline-block";
    }
  });
});

/* ===== LOGOUT ===== */
function logout(){
  if(!currentUser) return;
  db.ref("users/"+currentUser+"/online").set(false);
  auth.signOut();
  location.reload();
}

/* ===== AVATAR ===== */
document.getElementById("avatar").onclick=()=>{
  document.getElementById("avatarInput").click();
};

document.getElementById("avatarInput").addEventListener("change",function(){
  const file=this.files[0];
  if(!file) return;
  const r=new FileReader();
  r.onload=e=>{
    db.ref("users/"+currentUser+"/avatar").set(e.target.result);
  };
  r.readAsDataURL(file);
});
</script>
