<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Форум</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#0f111a;color:#eee}
header{background:#151826;padding:15px;display:flex;justify-content:space-between}
button{background:#ff6a00;border:none;color:#fff;padding:8px 12px;border-radius:5px;cursor:pointer}
.container{max-width:900px;margin:20px auto;background:#151826;padding:15px;border-radius:10px}
.topic{background:#1f2236;padding:10px;margin:5px 0;border-radius:5px;cursor:pointer}
.comment{background:#1c1f33;padding:8px;margin-top:5px;border-radius:5px}
.reply{margin-left:20px;background:#222654}
input,textarea{width:100%;background:#1f2236;border:none;color:#fff;padding:8px;border-radius:5px;margin:5px 0}
</style>
</head>
<body>

<header>
  <b>Форум</b>
  <span id="user"></span>
</header>

<div class="container" id="auth">
  <h3>Реєстрація</h3>
  <input id="nick" placeholder="Введіть нік">
  <button onclick="register()">Зареєструватися</button>
</div>

<div class="container" id="forum" style="display:none">
  <h3>Створити тему</h3>
  <input id="title" placeholder="Заголовок">
  <textarea id="text" placeholder="Текст"></textarea>
  <button onclick="createTopic()">Опублікувати</button>
  <hr>
  <div id="topics"></div>
</div>

<div class="container" id="thread" style="display:none"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user = localStorage.getItem("user");

if(user){
  document.getElementById("auth").style.display="none";
  document.getElementById("forum").style.display="block";
  document.getElementById("user").innerText = user;
}

function register(){
  const n = nick.value.trim();
  if(!n) return alert("Введи нік");
  db.ref("users/"+n).get().then(s=>{
    if(s.exists()) return alert("Нік зайнятий");
    db.ref("users/"+n).set({online:true});
    localStorage.setItem("user",n);
    location.reload();
  });
}

function createTopic(){
  db.ref("topics").push({
    title:title.value,
    text:text.value,
    author:user,
    time:Date.now()
  });
  title.value=""; text.value="";
}

db.ref("topics").on("value",snap=>{
  topics.innerHTML="";
  snap.forEach(t=>{
    const d=document.createElement("div");
    d.className="topic";
    d.innerHTML=`<b>${t.val().title}</b><br>${t.val().author}`;
    d.onclick=()=>openTopic(t.key);
    topics.appendChild(d);
  });
});

function openTopic(id){
  forum.style.display="none";
  thread.style.display="block";
  db.ref("topics/"+id).on("value",snap=>{
    const t=snap.val();
    thread.innerHTML=`
      <button onclick="back()">⬅ Назад</button>
      <h3>${t.title}</h3>
      <p>${t.text}</p>
      <small>${t.author}</small>
      <hr>
      <input id="cText" placeholder="Коментар">
      <button onclick="addComment('${id}')">Надіслати</button>
      <div id="comments"></div>
    `;
  });

  db.ref("comments/"+id).on("value",s=>{
    comments.innerHTML="";
    s.forEach(c=>{
      const d=document.createElement("div");
      d.className="comment";
      d.innerHTML=`<b>${c.val().author}</b>: ${c.val().text}
      <br><input placeholder="Відповідь" onkeydown="reply(event,'${id}','${c.key}')">`;
      comments.appendChild(d);

      db.ref("replies/"+c.key).on("value",r=>{
        r.forEach(x=>{
          const rr=document.createElement("div");
          rr.className="comment reply";
          rr.innerHTML=`<b>${x.val().author}</b>: ${x.val().text}`;
          d.appendChild(rr);
        });
      });
    });
  });
}

function addComment(id){
  db.ref("comments/"+id).push({
    author:user,
    text:cText.value
  });
  cText.value="";
}

function reply(e,tid,cid){
  if(e.key==="Enter"){
    db.ref("replies/"+cid).push({
      author:user,
      text:e.target.value
    });
    e.target.value="";
  }
}

function back(){
  thread.style.display="none";
  forum.style.display="block";
}
</script>
</body>
</html>
